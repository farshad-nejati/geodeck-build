import t,{useState as _,useEffect as n,useRef as l,Suspense as z}from"../../../_snowpack/pkg/react.js";import Q from"../studio-page/change-bar.js";import H from"./toolbar-3d.js";import W from"../bottom-bar/index.js";import $ from"../detail-bar/index.js";import{useMutation as j,useQuery as Y,useReactiveVar as f}from"../../../_snowpack/pkg/@apollo/client.js";import{detailBar as R,bottomBar as K}from"../../apollo/cache.js";import{OrbitControls as X,Stage as Z,GizmoViewport as ee,GizmoHelper as te,PerspectiveCamera as oe}from"../../../_snowpack/pkg/@react-three/drei.js";import{Canvas as re,useThree as ae}from"../../../_snowpack/pkg/@react-three/fiber.js";import{Leva as ne}from"../../../_snowpack/pkg/leva.js";import se from"./canvas-component.js";import le from"./loader.js";import{useClientRect as ce}from"../hooks/use-client-rect.js";import{activeProjectVar as ie,filesOfGalleryVar as x,GeometricObjectsVar as me,overlaysVar as B}from"../../apollo/cache.js";import{GET_OBJECTS as h}from"../../apollo/queries/index.js";import{CREATE_UPDATE_GEOMETRIC_OBJECTS as de,DELETE_GEOMETRIC_OBJECT as pe}from"../../apollo/mutations/index.js";import{message as c}from"../../../_snowpack/pkg/antd.js";import{useCallbackRef as fe}from"../hooks/use-callback-ref.js";import{ADD_FILE as ue}from"../../apollo/mutations/index.js";import{GET_FILES_OF_GALLERY as ge}from"../../apollo/queries/index.js";import"../../../_snowpack/pkg/three.js";import ve from"./overlay-container.js";const Ee="240px";function We(s){const i=l(),r=ae(b=>b.camera);return n(()=>{r.position.set(0,radius*.5,radius*2.5),r.near=.1,r.far=Math.max(5e3,radius*4),r.lookAt(0,y,0)},[]),t.createElement("perspectiveCamera",{ref:i,...s})}const S={items:[],meta:{x:0,y:0,z:0,radius:0}},je=({camera:s,setCamera:i})=>{const r=f(B),[b,w]=_(S);console.log("overlays:"),console.log(r),n(()=>{r?.items?.length&&w(r),B(S)},[r]);const u=x(),D=f(R),C=f(K),[O,T]=ce([C,R]),m=l(),I=l(),g=l(),v=l(),a=f(ie),[k,G]=_(a?.model?.file?.url),[d,V]=fe([k]),F=d?.querySelector("canvas");n(()=>{console.log("stage"),console.log(g)},[g]),console.log("camera"),console.log(s);const E="scshot";n(()=>{G(a?.model?.file?.url)},[a]);const he=Y(h,{variables:{projectId:a?.id},onCompleted:e=>{const o=e?.geometricObjectModel?.items;me(JSON.parse(JSON.stringify(o)))},onError:e=>{console.log("ERROR on fetch Data"),console.log(e)}}),[L]=j(ue,{refetchQueries:[{query:ge,variables:{galleryId:a?.gallery.id}}],onCompleted:({addFile:e})=>{const p=[e?.file,...u?.items],o={...u,items:p,total:u.total+1};x(o),c.success({content:"Successful!",sckey:E,duration:2})},onError:e=>{console.log(e),c.error({content:"Failed!",sckey:E,duration:2})}}),[N]=j(de,{refetchQueries:[{query:h,variables:{projectId:a?.id}}],onCompleted:e=>{c.success({content:"Objects Saved!",duration:2}),console.log(e)},onError:e=>{c.error({content:"Save Objects Failed!",duration:2}),console.log(e)}}),[q]=j(pe,{refetchQueries:[{query:h,variables:{projectId:a?.id}}],onCompleted:e=>{console.log("data"),console.log(e)},onError:e=>{console.log("error"),console.log(e)}}),A=e=>{e?(e.name="screenshot",L({variables:{galleryId:a?.gallery?.id,title:e?.name,file:e,varying:"3D"}})):c.warning({content:"Nothing to screenshot!",sckey:E,duration:2})},M=e=>{const p=e.map(o=>(o.temp&&o.temp===!0?(delete o.temp,delete o.id):(delete o.createdAt,delete o.updatedAt,delete o.__typename),o));N({variables:{objects:p}})},J=e=>{e.temp||q({variables:{objectId:e.id}})};n(()=>{if(d){const e=d.firstElementChild;e.style.top="65px"}},[d]),n(()=>()=>{console.log("setStateCamera called"),console.log("cameraRef?.current");const e=v?.current;console.log(e),P(v?.current)},[]);const P=e=>{e&&(console.log("Inline"),i({position:e?.position,rotation:e?.rotation,fov:e?.fov,far:e?.far}))},U=()=>t.createElement(re,{onCreated:e=>console.log("state:",e),style:{height:"100%"},dpr:[1,2]},t.createElement(z,{fallback:t.createElement(le,null)},t.createElement(Z,{controls:m,preset:"rembrandt",intensity:1,shadows:!1,environment:"city",adjustCamera:!0,ref:g},t.createElement(se,{ref:I,canvasElement:F,onSave:M,modelUrl:k,projectId:a?.id,getScreenShot:A,onDelete:J,cameraVar:s,setCameraVar:i}),t.createElement(oe,{makeDefault:!0,ref:v,...s})),t.createElement(X,{ref:m}),t.createElement(te,{alignment:"bottom-right",margin:[60,100],onTarget:()=>m?.current?.target,onUpdate:()=>m.current?.update},t.createElement(ee,{axisColors:["#d63031","#00b894","#0984e3"],labelColor:"black"}))));return t.createElement("div",{className:`studio-3d ${D?"two":""}`},t.createElement(H,null),t.createElement("div",{className:"studio-3d__main"},t.createElement("div",{className:`studio-3d__content ${C?"auto-height":""}`},t.createElement("div",{className:"canvas flex-1",ref:V},t.createElement(ne,{id:"leva",className:"leva",titleBar:{title:"Properties",drag:!0},theme:{sizes:{titleBarHeight:"32px",rootWidth:Ee},colors:{elevation1:"#343434",elevation2:"#292929",elevation3:"#343434",accent1:"#f2ab1f",accent2:"#f2ab1f",accent3:"#f2ab1f"}}}),t.createElement(ve,null),U())),t.createElement(W,{rect:O,ref:T})),t.createElement(Q,{bottomBarRef:O,toggle:!0}),t.createElement($,null))};export default je;
