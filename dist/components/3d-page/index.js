import t,{useState as q,useEffect as s,useRef as l,Suspense as w}from"https://cdn.skypack.dev/react";import A from"../studio-page/change-bar.js";import M from"./toolbar-3d.js";import J from"../bottom-bar/index.js";import P from"../detail-bar/index.js";import{useMutation as v,useQuery as U,useReactiveVar as h}from"https://cdn.skypack.dev/@apollo/client";import{detailBar as R,bottomBar as Q}from"../../apollo/cache.js";import{OrbitControls as z,Stage as H,GizmoViewport as W,GizmoHelper as $,PerspectiveCamera as Y}from"https://cdn.skypack.dev/@react-three/drei";import{Canvas as K,useThree as X}from"https://cdn.skypack.dev/@react-three/fiber";import{Leva as Z}from"https://cdn.skypack.dev/leva";import ee from"./canvas-component.js";import te from"./loader.js";import{useClientRect as oe}from"../hooks/use-client-rect.js";import{activeProjectVar as re,filesOfGalleryVar as _,GeometricObjectsVar as ae}from"../../apollo/cache.js";import{GET_OBJECTS as b}from"../../apollo/queries/index.js";import{CREATE_UPDATE_GEOMETRIC_OBJECTS as ne,DELETE_GEOMETRIC_OBJECT as se}from"../../apollo/mutations/index.js";import{message as c}from"https://cdn.skypack.dev/antd";import{useCallbackRef as le}from"../hooks/use-callback-ref.js";import{ADD_FILE as ce}from"../../apollo/mutations/index.js";import{GET_FILES_OF_GALLERY as ie}from"../../apollo/queries/index.js";import"https://cdn.skypack.dev/three";const me="240px";function we(n){const i=l(),a=X(g=>g.camera);return s(()=>{a.position.set(0,radius*.5,radius*2.5),a.near=.1,a.far=Math.max(5e3,radius*4),a.lookAt(0,y,0)},[]),t.createElement("perspectiveCamera",{ref:i,...n})}const de=({camera:n,setCamera:i})=>{const a=_(),g=h(R),j=h(Q),[C,B]=oe([j,R]),m=l(),k=l();console.log("inner"),console.log(k);const d=l();console.log("stage"),console.log(d);const p=l();console.log("cameraRef"),console.log(p);const r=h(re),[O,S]=q(r?.model?.file?.url),[f,x]=le([O]),D=f?.querySelector("canvas");s(()=>{console.log("stage"),console.log(d)},[d]),console.log("camera"),console.log(n);const E="scshot";s(()=>{S(r?.model?.file?.url)},[r]);const pe=U(b,{variables:{projectId:r?.id},onCompleted:e=>{const o=e?.geometricObjectModel?.items;ae(JSON.parse(JSON.stringify(o)))},onError:e=>{console.log("ERROR on fetch Data"),console.log(e)}}),[T]=v(ce,{refetchQueries:[{query:ie,variables:{galleryId:r?.gallery.id}}],onCompleted:({addFile:e})=>{const u=[e?.file,...a?.items],o={...a,items:u,total:a.total+1};_(o),c.success({content:"Successful!",sckey:E,duration:2})},onError:e=>{console.log(e),c.error({content:"Failed!",sckey:E,duration:2})}}),[I]=v(ne,{refetchQueries:[{query:b,variables:{projectId:r?.id}}],onCompleted:e=>{c.success({content:"Objects Saved!",duration:2}),console.log(e)},onError:e=>{c.error({content:"Save Objects Failed!",duration:2}),console.log(e)}}),[G]=v(se,{refetchQueries:[{query:b,variables:{projectId:r?.id}}],onCompleted:e=>{console.log("data"),console.log(e)},onError:e=>{console.log("error"),console.log(e)}}),V=e=>{e?(e.name="screenshot",T({variables:{galleryId:r?.gallery?.id,title:e?.name,file:e,varying:"3D"}})):c.warning({content:"Nothing to screenshot!",sckey:E,duration:2})},F=e=>{const u=e.map(o=>(o.temp&&o.temp===!0?(delete o.temp,delete o.id):(delete o.createdAt,delete o.updatedAt,delete o.__typename),o));I({variables:{objects:u}})},L=e=>{e.temp||G({variables:{objectId:e.id}})};s(()=>{if(f){const e=f.firstElementChild;e.style.top="65px"}},[f]),s(()=>()=>{console.log("setStateCamera called"),console.log("cameraRef?.current");const e=p?.current;console.log(e),N(p?.current)},[]);const N=e=>{e&&(console.log("Inline"),i({position:e?.position,rotation:e?.rotation,fov:e?.fov,far:e?.far}))};return t.createElement("div",{className:`studio-3d ${g?"two":""}`},t.createElement(M,null),t.createElement("div",{className:"studio-3d__main"},t.createElement("div",{className:`studio-3d__content ${j?"auto-height":""}`},t.createElement("div",{className:"canvas flex-1",ref:x},t.createElement(Z,{id:"leva",className:"leva",titleBar:{title:"Properties",drag:!0},theme:{sizes:{titleBarHeight:"32px",rootWidth:me},colors:{elevation1:"#343434",elevation2:"#292929",elevation3:"#343434",accent1:"#f2ab1f",accent2:"#f2ab1f",accent3:"#f2ab1f"}}}),t.createElement(K,{onCreated:e=>console.log("state:",e),style:{height:"100%"},dpr:[1,2]},t.createElement(w,{fallback:t.createElement(te,null)},t.createElement(H,{controls:m,preset:"rembrandt",intensity:1,shadows:!1,environment:"city",adjustCamera:!0,ref:d},t.createElement(ee,{ref:k,canvasElement:D,onSave:F,modelUrl:O,projectId:r?.id,getScreenShot:V,onDelete:L,cameraVar:n,setCameraVar:i}),t.createElement(Y,{makeDefault:!0,ref:p,...n})),t.createElement(z,{ref:m}),t.createElement($,{alignment:"bottom-right",margin:[60,100],onTarget:()=>m?.current?.target,onUpdate:()=>m.current?.update},t.createElement(W,{axisColors:["#d63031","#00b894","#0984e3"],labelColor:"black"})))))),t.createElement(J,{rect:C,ref:B})),t.createElement(A,{bottomBarRef:C,toggle:!0}),t.createElement(P,null))};export default de;
