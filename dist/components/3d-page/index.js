import t,{useState as k,useEffect as s,useRef as n,Suspense as A}from"../../../_snowpack/pkg/react.js";import M from"../studio-page/change-bar.js";import J from"./toolbar-3d.js";import P from"../bottom-bar/index.js";import U from"../detail-bar/index.js";import{useMutation as j,useQuery as z,useReactiveVar as p}from"../../../_snowpack/pkg/@apollo/client.js";import{detailBar as _,bottomBar as Q}from"../../apollo/cache.js";import{OrbitControls as H,Stage as W,GizmoViewport as $,GizmoHelper as Y,PerspectiveCamera as K}from"../../../_snowpack/pkg/@react-three/drei.js";import{Canvas as X,useThree as Z}from"../../../_snowpack/pkg/@react-three/fiber.js";import{Leva as ee}from"../../../_snowpack/pkg/leva.js";import"./canvas-component.js";import te from"./loader.js";import{useClientRect as oe}from"../hooks/use-client-rect.js";import{activeProjectVar as re,filesOfGalleryVar as R,GeometricObjectsVar as ae,overlaysVar as x}from"../../apollo/cache.js";import{GET_OBJECTS as h}from"../../apollo/queries/index.js";import{CREATE_UPDATE_GEOMETRIC_OBJECTS as se,DELETE_GEOMETRIC_OBJECT as ne}from"../../apollo/mutations/index.js";import{message as l}from"../../../_snowpack/pkg/antd.js";import{useCallbackRef as le}from"../hooks/use-callback-ref.js";import{ADD_FILE as ce}from"../../apollo/mutations/index.js";import{GET_FILES_OF_GALLERY as ie}from"../../apollo/queries/index.js";import"../../../_snowpack/pkg/three.js";import me from"./overlay-container.js";const de="240px";function We(c){const f=n(),r=Z(b=>b.camera);return s(()=>{r.position.set(0,radius*.5,radius*2.5),r.near=.1,r.far=Math.max(5e3,radius*4),r.lookAt(0,y,0)},[]),t.createElement("perspectiveCamera",{ref:f,...c})}const B={items:[],meta:{x:0,y:0,z:0,radius:0}},pe=({camera:c,setCamera:f})=>{const r=p(x),[b,S]=k(B);console.log("overlays:"),console.log(r),s(()=>{r?.items?.length&&S(r),x(B)},[r]);const u=R(),w=p(_),C=p(Q),[O,D]=oe([C,_]),i=n(),fe=n(),g=n(),v=n(),a=p(re),[T,I]=k(a?.model?.file?.url),[m,G]=le([T]),ue=m?.querySelector("canvas");s(()=>{console.log("stage"),console.log(g)},[g]),console.log("camera"),console.log(c);const E="scshot";s(()=>{I(a?.model?.file?.url)},[a]);const ge=z(h,{variables:{projectId:a?.id},onCompleted:e=>{const o=e?.geometricObjectModel?.items;ae(JSON.parse(JSON.stringify(o)))},onError:e=>{console.log("ERROR on fetch Data"),console.log(e)}}),[F]=j(ce,{refetchQueries:[{query:ie,variables:{galleryId:a?.gallery.id}}],onCompleted:({addFile:e})=>{const d=[e?.file,...u?.items],o={...u,items:d,total:u.total+1};R(o),l.success({content:"Successful!",sckey:E,duration:2})},onError:e=>{console.log(e),l.error({content:"Failed!",sckey:E,duration:2})}}),[L]=j(se,{refetchQueries:[{query:h,variables:{projectId:a?.id}}],onCompleted:e=>{l.success({content:"Objects Saved!",duration:2}),console.log(e)},onError:e=>{l.error({content:"Save Objects Failed!",duration:2}),console.log(e)}}),[V]=j(ne,{refetchQueries:[{query:h,variables:{projectId:a?.id}}],onCompleted:e=>{console.log("data"),console.log(e)},onError:e=>{console.log("error"),console.log(e)}}),ve=e=>{e?(e.name="screenshot",F({variables:{galleryId:a?.gallery?.id,title:e?.name,file:e,varying:"3D"}})):l.warning({content:"Nothing to screenshot!",sckey:E,duration:2})},Ee=e=>{const d=e.map(o=>(o.temp&&o.temp===!0?(delete o.temp,delete o.id):(delete o.createdAt,delete o.updatedAt,delete o.__typename),o));L({variables:{objects:d}})},je=e=>{e.temp||V({variables:{objectId:e.id}})};s(()=>{if(m){const e=m.firstElementChild;e.style.top="65px"}},[m]),s(()=>()=>{console.log("setStateCamera called"),console.log("cameraRef?.current");const e=v?.current;console.log(e),N(v?.current)},[]);const N=e=>{e&&(console.log("Inline"),f({position:e?.position,rotation:e?.rotation,fov:e?.fov,far:e?.far}))},q=()=>t.createElement(X,{onCreated:e=>console.log("state:",e),style:{height:"100%"},dpr:[1,2]},t.createElement(A,{fallback:t.createElement(te,null)},t.createElement(W,{controls:i,preset:"rembrandt",intensity:1,shadows:!1,environment:"city",adjustCamera:!0,ref:g},t.createElement(K,{makeDefault:!0,ref:v,...c})),t.createElement(H,{ref:i}),t.createElement(Y,{alignment:"bottom-right",margin:[60,100],onTarget:()=>i?.current?.target,onUpdate:()=>i.current?.update},t.createElement($,{axisColors:["#d63031","#00b894","#0984e3"],labelColor:"black"}))));return t.createElement("div",{className:`studio-3d ${w?"two":""}`},t.createElement(J,null),t.createElement("div",{className:"studio-3d__main"},t.createElement("div",{className:`studio-3d__content ${C?"auto-height":""}`},t.createElement("div",{className:"canvas flex-1",ref:G},t.createElement(ee,{id:"leva",className:"leva",titleBar:{title:"Properties",drag:!0},theme:{sizes:{titleBarHeight:"32px",rootWidth:de},colors:{elevation1:"#343434",elevation2:"#292929",elevation3:"#343434",accent1:"#f2ab1f",accent2:"#f2ab1f",accent3:"#f2ab1f"}}}),t.createElement(me,null),q())),t.createElement(P,{rect:O,ref:D})),t.createElement(M,{bottomBarRef:O,toggle:!0}),t.createElement(U,null))};export default pe;
