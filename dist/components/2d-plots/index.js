import p,{useEffect as A,useState as M}from"../../../_snowpack/pkg/react.js";import m from"../../../_snowpack/pkg/lodash.js";import{message as E}from"../../../_snowpack/pkg/antd.js";import B from"./plot-card.js";import F from"./plot-new.js";import{useMutation as W,useQuery as Q,useReactiveVar as O}from"../../../_snowpack/pkg/@apollo/client.js";import{GET_PLOTS as z}from"../../apollo/queries/index.js";import{activeProjectVar as H,containersVar as h,plotsVar as r}from"../../apollo/cache.js";import{getPlotsData as J}from"../../data/plots-data.js";import{CONTAINER_STATE as K,PLOT_STATE as X}from"../../apollo/initial-states.js";import*as s from"../../helpers/plot.js";import*as Y from"../../helpers/container.js";import*as T from"../../helpers/geo-object.js";import*as Z from"../../helpers/geo-variable.js";import $ from"../auto-save.js";import tt from"../hooks/use-undo.js";import"../../helpers/store-handler.js";import{UPDATE_PLOT as et}from"../../apollo/mutations/index.js";const ot=()=>{const k=H(),{plots:n,active:v}=O(r),{containers:P,active:u}=O(h),[L,b]=M(n),S=s.getAsArray(n),[_,{set:y,reset:st,undo:at,redo:nt,canUndo:ct,canRedo:rt}]=tt(n),{loading:it,error:lt,data:pt}=Q(z,{variables:{projectId:k.id},onCompleted:e=>{const t=e?.plotModel;g(t)},onError:()=>{const t=J()?.plotModel;g(t)}}),[I]=W(et,{onCompleted:e=>{E.success({content:"saved successfull!",key:"save-plot",duration:1})}});A(()=>{y(n)},[n]);const g=e=>{const t=e?.items,o=s.create(t);r({plots:o})};A(()=>{const e=w(),t=s.update(v,e),o=s.updateList(n,t);r({plots:o,active:t})},[u]);const C=e=>{let{newActive:t,newItems:o}=s.changeActive(n,v,e);const a=w();t=s.update(t,a),o=s.updateList(o,t),r({plots:o,active:t})},w=()=>{const e=Y.findSelected(P),{variables:t,activeVariable:o}=u,a=T.findSelected(e),{points:c,lines:l}=T.getDevided(a),i=Z.findByName(t,o);return{variableObjects:a,variable:i,points:c,lines:l}},V=e=>{const t=s.deletePlot(n,e);r({plots:t,active:X})},x=(e,t)=>{const o=s.findById(n,e),a=s.update(o,t),c=s.updateList(n,a);r({plots:c,active:a})},N=e=>{const t=s.updateList(n,e),{newActive:o,newItems:a}=s.changeActive(t,v,e.id);h({containers:P,active:K}),r({plots:a,active:o})},U=(e,t)=>{const o=s.removeTemps(n,e,t),a=s.update(e,{isActive:!0}),c=s.updateList(o,a);r({plots:c,active:a})},D=e=>{const{plotsState:t,lastSaved:o}=e,{present:a}=t,c=s.removeActiveState(o),l=s.removeActiveState(a),i=m.differenceWith(l,c,m.isEqual);if(b(a),m.isEqual(l,i)||m.isEmpty(i))return null;const j="save-plot";E.loading({content:"saving...",key:j}),i?.map(d=>{const f=d.id,{variable:R}=d,q=R.id,G=s.extractvariableObjectIds(d?.variableObjects);I({variables:{plotId:f,object:{variableObjectIds:G,variableId:q}}})}),b(a)};return p.createElement(p.Fragment,null,p.createElement("div",{className:"grid__plot plot"},p.createElement(F,{onCreateTemp:N,onOverWriteTemp:U,plotsLength:S?.length}),S?.map((e,t)=>{const{id:o,name:a,isActive:c,type:l,variable:i,variableObjects:j,points:d,lines:f}=e;return p.createElement(B,{key:o,objects:u.isPoint?d:f,id:o,name:a,type:l,variable:i,isActive:c,variableObjects:j,onUpdatePlot:x,onSelectPlot:C,onDeletePlot:V})})),p.createElement($,{onSave:D,data:{plotsState:_,lastSaved:L},interval:5e3}))};export default ot;
