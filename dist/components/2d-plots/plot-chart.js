import l,{useEffect as T,useMemo as k}from"https://cdn.skypack.dev/react";import b from"https://cdn.skypack.dev/react-dom/server";import c from"https://cdn.skypack.dev/lodash";import{message as h}from"https://cdn.skypack.dev/antd";import A from"https://cdn.skypack.dev/react-apexcharts";import j from"https://cdn.skypack.dev/apexcharts";import I from"./chart-options.js";import{useMutation as L}from"https://cdn.skypack.dev/@apollo/client";import{GET_FILES_OF_GALLERY as $}from"../../apollo/queries/index.js";import{ADD_FILE as z}from"../../apollo/mutations/index.js";import{DeleteOutlined as C,SaveOutlined as G}from"https://cdn.skypack.dev/@ant-design/icons";import{findMaxInSeries as S,findMinInSeries as X}from"../2d-page/helper-2d.js";import{activeProjectVar as B}from"../../apollo/cache.js";import{SVGToImage as N}from"../3d-page/helpers.js";const R=f=>{const{id:M,name:u,type:d,variable:n,series:a}=f,g=B(),i=`plot-${M}`,x=c.toLower(d),y=n?.name?c.capitalize(n?.name):"Y",v=n?.unit?`(${n.unit})`:"",[F]=L(z,{refetchQueries:[{query:$,variables:{galleryId:g?.gallery.id}}],onCompleted:({addFile:t})=>{h.success({content:"Plot saved Successfully!",key:i,duration:2})},onError:t=>{console.log(t),h.error({content:"Plot save Failed!",key:i,duration:2})}});T(()=>{const t=S(a,"x"),s=Math.ceil(t/5)*5,r=X(a,"y"),e=S(a,"y"),o=e-r,m=o>20?Math.floor(r/5)*5:Math.floor(r),O=o>20?Math.ceil(e/5)*5:Math.ceil(e+1);j.exec(i,"updateOptions",{xaxis:{labels:{formatter:p=>p?.toFixed(1)},max:s,title:{text:a.length?"Timestep (s)":"X"},tickAmount:10,tickPlacement:"on"},yaxis:{min:()=>d==="bar"?0:m,max:O,forceNiceScale:!1,tickAmount:o>10?10:o+1,axisBorder:{show:!0,color:"#d5d5d5",offsetX:-2},axisTicks:{show:!0,width:6,offsetX:9},title:{text:`${y} ${v}`},labels:{formatter:p=>p?.toFixed(0)}}})},[a,d]);const _=t=>{h.loading({content:"Please wait...",key:i}),t.globals.svgWidth=1920,t.globals.svgHeight=1080;const r=t.globals.dom.Paper.node.cloneNode(!0);r.setAttribute("width","1920px"),r.setAttribute("height","1080px"),r.setAttribute("viewBox","-10 0 600 300");const e=new XMLSerializer().serializeToString(r);N({svg:e,mimetype:"image/png",quality:1,outputFormat:"blob"}).then(function(o){F({variables:{galleryId:g?.gallery?.id,title:u,file:o,varying:"2D"}})}).catch(function(o){console.log(o)})},w=()=>{f.onDeletePlot()},D=((t,s,r)=>({chart:{id:r,type:s,toolbar:{offsetY:-30,tools:{customIcons:[{icon:b.renderToString(l.createElement(G,{style:{fontSize:"16px"}})),index:4,title:"Save To Gallery",class:"icon__save",click:(e,o,m)=>{_(o)}},{icon:b.renderToString(l.createElement(C,{style:{fontSize:"16px"}})),index:5,title:"Delete Plot",class:"icon__save",click:(e,o,m)=>{w()}}]},export:{csv:{filename:t,columnDelimiter:",",headerCategory:"category",headerValue:"value",dateFormatter(e){return new Date(e).toDateString()}},svg:{filename:t},png:{filename:t}}},zoom:{type:"xy"}},legend:{formatter:e=>`${e}`,markers:{width:12,height:12,radius:12},itemMargin:{horizontal:8,vertical:0}},tooltip:{y:{formatter:e=>e?.toFixed(4)}},xaxis:{title:{text:"X"},tickAmount:10},yaxis:{title:{text:`${y} ${v}`},labels:{formatter:e=>e?.toFixed(2)}}}))(u,x,i),E=k(()=>c.cloneDeep(I),[]),P=k(()=>c.merge({...E},D),[]);return l.createElement("div",{className:`plot__chart  chart__wrapper ${a.length?"bordered":""}`},l.createElement(A,{options:P,series:a,type:x,width:"100%",height:"100%"}))};export default R;
