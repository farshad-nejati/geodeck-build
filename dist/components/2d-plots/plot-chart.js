import l,{useEffect as O,useMemo as k}from"../../../_snowpack/pkg/react.js";import b from"../../../_snowpack/pkg/react-dom/server.js";import c from"../../../_snowpack/pkg/lodash.js";import{message as g}from"../../../_snowpack/pkg/antd.js";import T from"../../../_snowpack/pkg/react-apexcharts.js";import A from"../../../_snowpack/pkg/apexcharts.js";import I from"./chart-options.js";import{useMutation as L}from"../../../_snowpack/pkg/@apollo/client.js";import{GET_FILES_OF_GALLERY as $}from"../../apollo/queries/index.js";import{ADD_FILE as z}from"../../apollo/mutations/index.js";import{DeleteOutlined as C,SaveOutlined as G}from"../../../_snowpack/pkg/@ant-design/icons.js";import{findMaxInSeries as _,findMinInSeries as X}from"../2d-page/helper-2d.js";import{activeProjectVar as B}from"../../apollo/cache.js";import{SVGToImage as N}from"../3d-page/helpers.js";const R=f=>{const{id:w,name:u,type:m,variable:n,series:a}=f,h=B(),i=`plot-${w}`,x=c.toLower(m),y=n?.name?c.capitalize(n?.name):"Y",v=n?.unit?`(${n.unit})`:"",[S]=L(z,{refetchQueries:[{query:$,variables:{galleryId:h?.gallery.id}}],onCompleted:({addFile:t})=>{g.success({content:"Plot saved Successfully!",key:i,duration:2})},onError:t=>{console.log(t),g.error({content:"Plot save Failed!",key:i,duration:2})}});O(()=>{const t=_(a,"x"),s=Math.ceil(t/5)*5,r=X(a,"y"),e=_(a,"y"),o=e-r,p=o>20?Math.floor(r/5)*5:Math.floor(r),P=o>20?Math.ceil(e/5)*5:Math.ceil(e+1);A.exec(i,"updateOptions",{xaxis:{labels:{formatter:d=>d?.toFixed(1)},max:s,title:{text:a.length?"Timestep (s)":"X"},tickAmount:10,tickPlacement:"on"},yaxis:{min:()=>m==="bar"?0:p,max:P,forceNiceScale:!1,tickAmount:o>10?10:o+1,axisBorder:{show:!0,color:"#d5d5d5",offsetX:-2},axisTicks:{show:!0,width:6,offsetX:9},title:{text:`${y} ${v}`},labels:{formatter:d=>d?.toFixed(0)}}})},[a,m]);const M=t=>{g.loading({content:"Please wait...",key:i}),t.globals.svgWidth=1920,t.globals.svgHeight=1080;const r=t.globals.dom.Paper.node.cloneNode(!0);r.setAttribute("width","1920px"),r.setAttribute("height","1080px"),r.setAttribute("viewBox","-10 0 600 300");const e=new XMLSerializer().serializeToString(r);N({svg:e,mimetype:"image/png",quality:1,outputFormat:"blob"}).then(function(o){S({variables:{galleryId:h?.gallery?.id,title:u,file:o,varying:"2D"}})}).catch(function(o){console.log(o)})},j=()=>{f.onDeletePlot()},F=((t,s,r)=>({chart:{id:r,type:s,toolbar:{offsetY:-30,tools:{customIcons:[{icon:b.renderToString(l.createElement(G,{style:{fontSize:"16px"}})),index:4,title:"Save To Gallery",class:"icon__save",click:(e,o,p)=>{M(o)}},{icon:b.renderToString(l.createElement(C,{style:{fontSize:"16px"}})),index:5,title:"Delete Plot",class:"icon__save",click:(e,o,p)=>{j()}}]},export:{csv:{filename:t,columnDelimiter:",",headerCategory:"category",headerValue:"value",dateFormatter(e){return new Date(e).toDateString()}},svg:{filename:t},png:{filename:t}}},zoom:{type:"xy"}},legend:{formatter:e=>`${e}`,markers:{width:12,height:12,radius:12},itemMargin:{horizontal:8,vertical:0}},tooltip:{y:{formatter:e=>e?.toFixed(4)}},xaxis:{title:{text:"X"},tickAmount:10},yaxis:{title:{text:`${y} ${v}`},labels:{formatter:e=>e?.toFixed(2)}}}))(u,x,i),D=k(()=>c.cloneDeep(I),[]),E=k(()=>c.merge({...D},F),[]);return l.createElement("div",{className:`plot__chart  chart__wrapper ${a.length?"bordered":""}`},l.createElement(T,{options:E,series:a,type:x,width:"100%",height:"100%"}))};export default R;
